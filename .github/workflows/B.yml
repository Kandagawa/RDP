name: RDP-Tailscale-Rustdesk B+

on:
  workflow_dispatch:
    inputs:
      USERNAME:
        description: 'TÃªn ngÆ°á»i dÃ¹ng Windows'
        required: true
        default: 'Administrator'
      PASSWORD:
        description: 'Máº­t kháº©u RDP (tá»‘i thiá»ƒu 8 kÃ½ tá»±)'
        required: true
        default: 'Aa123456'
      TAILSCALE_AUTHKEY:
        description: 'Tailscale Auth Key (dáº¡ng tskey-...)'
        required: true
        default: 'tskey-xxxxxxxxxxxxxxxxxxxxxx'
      RUSTDESK_ID:
        description: 'RustDesk ID (tuá»³ chá»n)'
        required: false
      RUSTDESK_PWD:
        description: 'RustDesk Password (tuá»³ chá»n)'
        required: false

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
    - name: Thiáº¿t láº­p mÃ´i trÆ°á»ng
      run: |
        Write-Host "CÃ i Ä‘áº·t mÃ´i trÆ°á»ng Windows RDP + Tailscale + RustDesk..."
        Set-ExecutionPolicy Bypass -Scope Process -Force

    - name: CÃ i Ä‘áº·t Tailscale
      run: |
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale-setup.exe
        Start-Process -Wait -FilePath .\tailscale-setup.exe /S
        Start-Sleep -Seconds 10
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey "${{ github.event.inputs.TAILSCALE_AUTHKEY }}" --hostname github-rdp
        Write-Host "âœ… Káº¿t ná»‘i Tailscale thÃ nh cÃ´ng!"

    - name: Cáº¥u hÃ¬nh ngÆ°á»i dÃ¹ng RDP
      run: |
        net user ${{ github.event.inputs.USERNAME }} ${{ github.event.inputs.PASSWORD }} /add
        net localgroup administrators ${{ github.event.inputs.USERNAME }} /add
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "âœ… ÄÃ£ báº­t Remote Desktop thÃ nh cÃ´ng!"

    - name: CÃ i Ä‘áº·t RustDesk (tÃ¹y chá»n)
      run: |
        $id = "${{ github.event.inputs.RUSTDESK_ID }}"
        $pwd = "${{ github.event.inputs.RUSTDESK_PWD }}"
        Invoke-WebRequest https://github.com/rustdesk/rustdesk/releases/latest/download/rustdesk.exe -OutFile rustdesk.exe
        if ($id -ne "") {
          Start-Process -FilePath ".\rustdesk.exe" -ArgumentList "--id $id --password $pwd" -WindowStyle Hidden
          Write-Host "âœ… RustDesk Ä‘Ã£ cháº¡y ná»n vá»›i ID: $id"
        } else {
          Start-Process -FilePath ".\rustdesk.exe" -WindowStyle Hidden
          Write-Host "âš™ï¸ RustDesk Ä‘ang cháº¡y (ID táº¡o tá»± Ä‘á»™ng)"
        }

    - name: Hiá»ƒn thá»‹ thÃ´ng tin káº¿t ná»‘i
      run: |
        Write-Host "------------------------------------------------------"
        Write-Host "ğŸ‰ RDP Ä‘Ã£ sáºµn sÃ ng!"
        Write-Host "ğŸ‘‰ Username: ${{ github.event.inputs.USERNAME }}"
        Write-Host "ğŸ‘‰ Password: ${{ github.event.inputs.PASSWORD }}"
        Write-Host "ğŸ‘‰ Tailscale: ÄÄƒng nháº­p vÃ o tÃ i khoáº£n cá»§a báº¡n Ä‘á»ƒ tháº¥y mÃ¡y 'github-rdp'"
        Write-Host "------------------------------------------------------"

    - name: Keep session alive (Auto Loop)
      run: |
        echo "ğŸŒ€ Báº¯t Ä‘áº§u giá»¯ cho mÃ¡y luÃ´n hoáº¡t Ä‘á»™ng..."
        while ($true) {
          Start-Sleep -Seconds 300
          Write-Host "âœ… MÃ¡y váº«n hoáº¡t Ä‘á»™ng - $(Get-Date)"
        }
