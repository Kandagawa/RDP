name: RDP-Tailscale-Rustdesk B+

on:
  workflow_dispatch:
    inputs:
      USERNAME:
        description: 'Tên người dùng Windows'
        required: true
        default: 'Administrator'
      PASSWORD:
        description: 'Mật khẩu RDP (tối thiểu 8 ký tự)'
        required: true
        default: 'Aa123456'
      TAILSCALE_AUTHKEY:
        description: 'Tailscale Auth Key (dạng tskey-...)'
        required: true
        default: 'tskey-xxxxxxxxxxxxxxxxxxxxxx'
      RUSTDESK_ID:
        description: 'RustDesk ID (tuỳ chọn)'
        required: false
      RUSTDESK_PWD:
        description: 'RustDesk Password (tuỳ chọn)'
        required: false

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
    - name: Thiết lập môi trường
      run: |
        Write-Host "Cài đặt môi trường Windows RDP + Tailscale + RustDesk..."
        Set-ExecutionPolicy Bypass -Scope Process -Force

    - name: Cài đặt Tailscale
      run: |
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale-setup.exe
        Start-Process -Wait -FilePath .\tailscale-setup.exe /S
        Start-Sleep -Seconds 10
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey "${{ github.event.inputs.TAILSCALE_AUTHKEY }}" --hostname github-rdp
        Write-Host "✅ Kết nối Tailscale thành công!"

    - name: Cấu hình người dùng RDP
      run: |
        net user ${{ github.event.inputs.USERNAME }} ${{ github.event.inputs.PASSWORD }} /add
        net localgroup administrators ${{ github.event.inputs.USERNAME }} /add
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "✅ Đã bật Remote Desktop thành công!"

    - name: Cài đặt RustDesk (tùy chọn)
      run: |
        $id = "${{ github.event.inputs.RUSTDESK_ID }}"
        $pwd = "${{ github.event.inputs.RUSTDESK_PWD }}"
        Invoke-WebRequest https://github.com/rustdesk/rustdesk/releases/latest/download/rustdesk.exe -OutFile rustdesk.exe
        if ($id -ne "") {
          Start-Process -FilePath ".\rustdesk.exe" -ArgumentList "--id $id --password $pwd" -WindowStyle Hidden
          Write-Host "✅ RustDesk đã chạy nền với ID: $id"
        } else {
          Start-Process -FilePath ".\rustdesk.exe" -WindowStyle Hidden
          Write-Host "⚙️ RustDesk đang chạy (ID tạo tự động)"
        }

    - name: Hiển thị thông tin kết nối
      run: |
        Write-Host "------------------------------------------------------"
        Write-Host "🎉 RDP đã sẵn sàng!"
        Write-Host "👉 Username: ${{ github.event.inputs.USERNAME }}"
        Write-Host "👉 Password: ${{ github.event.inputs.PASSWORD }}"
        Write-Host "👉 Tailscale: Đăng nhập vào tài khoản của bạn để thấy máy 'github-rdp'"
        Write-Host "------------------------------------------------------"

    - name: Keep session alive (Auto Loop)
      run: |
        echo "🌀 Bắt đầu giữ cho máy luôn hoạt động..."
        while ($true) {
          Start-Sleep -Seconds 300
          Write-Host "✅ Máy vẫn hoạt động - $(Get-Date)"
        }
