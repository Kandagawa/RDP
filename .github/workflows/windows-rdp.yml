name: Windows RDP Full Info to Discord

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Enable RDP & Firewall
      run: |
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" `
          -Name "fDenyTSConnections" -Value 0
        netsh advfirewall firewall set rule group="remote desktop" new enable=yes

    - name: Download Cloudflared
      run: |
        Invoke-WebRequest `
          -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" `
          -OutFile "$env:USERPROFILE\cloudflared.exe"

    - name: Start Cloudflare Tunnel and Save Output
      id: tunnel
      run: |
        $cloudflared = "$env:USERPROFILE\cloudflared.exe"

        # Láº¥y link RDP chÃ­nh xÃ¡c
        $rdp_link = & $cloudflared tunnel --url rdp://localhost:3389 --print-url
        echo "RDP_LINK=$rdp_link" >> $env:GITHUB_ENV

        # Set thÃ´ng tin
        $username = "runneradmin"
        $password = "Password123!"
        $created_at = Get-Date -Format "yyyy-MM-dd HH:mm:ss"

        echo "USERNAME=$username" >> $env:GITHUB_ENV
        echo "PASSWORD=$password" >> $env:GITHUB_ENV
        echo "CREATED_AT=$created_at" >> $env:GITHUB_ENV
        echo "RUNNER_NAME=$env:RUNNER_NAME" >> $env:GITHUB_ENV
        echo "RUNNER_OS=$env:RUNNER_OS" >> $env:GITHUB_ENV

    - name: Send Full Info to Discord
      run: |
        $discordWebhook = "https://discord.com/api/webhooks/1438779054550417511/6Q-W-E5GTLVoE0zkK8ZBQ3nrt-ZDWFSOSPw5058Y7MY0iDse5_oAS7wmBRMJoNR0UhYk"

        $msg = @"
**Windows RDP VM Info**
---------------------------------
ğŸ”— **Link:** $env:RDP_LINK
ğŸ‘¤ **Username:** $env:USERNAME
ğŸ” **Password:** $env:PASSWORD

ğŸ–¥ **Runner Name:** $env:RUNNER_NAME
ğŸ’½ **Runner OS:** $env:RUNNER_OS
ğŸ•’ **Created At:** $env:CREATED_AT
"@

        $payload = @{ content = $msg } | ConvertTo-Json
        Invoke-RestMethod -Uri $discordWebhook -Method POST -Body $payload -ContentType "application/json"
