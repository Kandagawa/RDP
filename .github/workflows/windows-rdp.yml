name: Windows RDP Full Info to Discord

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Enable RDP & Firewall
      shell: pwsh
      run: |
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        netsh advfirewall firewall set rule group="remote desktop" new enable=yes

    - name: Download Cloudflared
      shell: pwsh
      run: |
        Invoke-WebRequest "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" `
          -OutFile "$env:USERPROFILE\cloudflared.exe"

    - name: Start Cloudflare Tunnel and extract link
      shell: pwsh
      run: |
        $cf = "$env:USERPROFILE\cloudflared.exe"

        # Ch·∫°y tunnel t·∫°m th·ªùi ‚Üí cloudflare t·ª± t·∫°o domain!
        $process = Start-Process -FilePath $cf -ArgumentList "tunnel --url tcp://localhost:3389" -NoNewWindow -RedirectStandardOutput output.txt -RedirectStandardError error.txt -PassThru

        Start-Sleep -Seconds 8

        $log = Get-Content output.txt | Out-String

        # L·∫•y d√≤ng c√≥ link Cloudflare TCP
        $link = ($log -split "`n" | Select-String -Pattern "tcp://" | Select-Object -First 1).ToString().Trim()

        if (!$link) {
          Write-Host "‚ùå Kh√¥ng t√¨m th·∫•y link cloudflare!"
          $link = "Kh√¥ng l·∫•y ƒë∆∞·ª£c link!"
        }

        Add-Content -Path $env:GITHUB_ENV -Value "RDP_LINK=$link"
        Add-Content -Path $env:GITHUB_ENV -Value "USERNAME=runneradmin"
        Add-Content -Path $env:GITHUB_ENV -Value "PASSWORD=Password123!"
        Add-Content -Path $env:GITHUB_ENV -Value "CREATED_AT=$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Add-Content -Path $env:GITHUB_ENV -Value "RUNNER_NAME=$env:RUNNER_NAME"
        Add-Content -Path $env:GITHUB_ENV -Value "RUNNER_OS=$env:RUNNER_OS"

    - name: Send Full Info to Discord
      shell: pwsh
      run: |
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

        $webhook = "https://discord.com/api/webhooks/1438785138170269787/2gW1Ln2I362LHpT5hIex2bmoMSrGyy536licIWsrznhgX0kh2i5oRvaT_sJ6DcY5sS3D"

        $msg = "**Windows RDP VM Info**`n" +
               "-----------------------`n" +
               "üîó Link: $env:RDP_LINK`n" +
               "üë§ Username: $env:USERNAME`n" +
               "üîê Password: $env:PASSWORD`n" +
               "üñ• Runner Name: $env:RUNNER_NAME`n" +
               "üíΩ Runner OS: $env:RUNNER_OS`n" +
               "üïí Created At: $env:CREATED_AT"

        $payload = @{ content = $msg } | ConvertTo-Json -Compress

        Invoke-RestMethod -Uri $webhook -Method POST -Body $payload -ContentType "application/json"

    - name: Output Info to Log
      shell: pwsh
      run: |
        Write-Host "===== Windows RDP VM Info ====="
        Write-Host "Link: $env:RDP_LINK"
        Write-Host "Username: $env:USERNAME"
        Write-Host "Password: $env:PASSWORD"
        Write-Host "Runner Name: $env:RUNNER_NAME"
        Write-Host "Runner OS: $env:RUNNER_OS"
        Write-Host "Created At: $env:CREATED_AT"