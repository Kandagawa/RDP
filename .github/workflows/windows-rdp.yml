name: Windows RDP Info in Logs

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Enable RDP & Firewall
      shell: pwsh
      run: |
        # Bật RDP trên runner
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        # Mở firewall cho Remote Desktop
        netsh advfirewall firewall set rule group="remote desktop" new enable=yes

    - name: Download Cloudflared
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "$env:USERPROFILE\cloudflared.exe"

    - name: Start Cloudflare Tunnel and Save Info
      shell: pwsh
      run: |
        $cloudflared = "$env:USERPROFILE\cloudflared.exe"
        # Start tunnel và lấy link RDP
        try {
            $rdp_link = & $cloudflared tunnel --url rdp://localhost:3389 --print-url
        } catch {
            $rdp_link = "FAILED_TO_GET_LINK"
        }

        # Thông tin Windows runner
        $username = "runneradmin"
        $password = "Password123!"
        $runner_name = $env:RUNNER_NAME
        $runner_os = $env:RUNNER_OS
        $created_at = Get-Date -Format "yyyy-MM-dd HH:mm:ss"

        # Log info ra console
        Write-Host "===== Windows RDP VM Info ====="
        Write-Host "RDP Link: $rdp_link"
        Write-Host "Username: $username"
        Write-Host "Password: $password"
        Write-Host "Runner Name: $runner_name"
        Write-Host "Runner OS: $runner_os"
        Write-Host "Created At: $created_at"
        Write-Host "==============================="