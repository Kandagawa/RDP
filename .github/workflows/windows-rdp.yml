name: Windows RDP Test with Discord

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Download Cloudflared
      run: |
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "$env:USERPROFILE\cloudflared.exe"

    - name: Start Cloudflare Tunnel and get URL
      id: tunnel
      run: |
        $cloudflared = "$env:USERPROFILE\cloudflared.exe"
        $output = & $cloudflared tunnel --url rdp://localhost:3389 --print-url
        Write-Host "RDP_LINK=$output" | Out-File -FilePath "$env:GITHUB_ENV" -Encoding utf8

    - name: Send RDP link to Discord
      run: |
        $discordWebhook = "https://discord.com/api/webhooks/1438777680748216360/K_ZrC7c1rP3P0DDyPwm_StWPe93PHX8HMZeg1BuJ9kRRfrE4ksEDeh9AiKNHz-Dw_4KZ"
        $rdp_link = $env:RDP_LINK
        Invoke-RestMethod -Uri $discordWebhook -Method POST -Body (@{content="Your Windows RDP is ready: $rdp_link"} | ConvertTo-Json) -ContentType "application/json"
