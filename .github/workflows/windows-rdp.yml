name: Windows RDP Full Info to Discord

on:
  workflow_dispatch:   # NÃºt Run workflow xuáº¥t hiá»‡n

jobs:
  rdp:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Enable RDP & Firewall
      shell: pwsh
      run: |
        # Báº­t RDP
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" `
          -Name "fDenyTSConnections" -Value 0
        # Má»Ÿ firewall cho Remote Desktop
        netsh advfirewall firewall set rule group="remote desktop" new enable=yes

    - name: Download Cloudflared
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "$env:USERPROFILE\cloudflared.exe"

    - name: Start Cloudflare Tunnel & Save Info
      shell: pwsh
      run: |
        $cf = "$env:USERPROFILE\cloudflared.exe"
        # Start tunnel vÃ  láº¥y link RDP
        try {
            $rdp_link = & $cf tunnel --url rdp://localhost:3389 --print-url
        } catch {
            $rdp_link = "FAILED_TO_GET_LINK"
        }

        # LÆ°u biáº¿n mÃ´i trÆ°á»ng
        echo "RDP_LINK=$rdp_link" >> $env:GITHUB_ENV
        echo "USERNAME=runneradmin" >> $env:GITHUB_ENV
        echo "PASSWORD=Password123!" >> $env:GITHUB_ENV
        echo "CREATED_AT=$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> $env:GITHUB_ENV
        echo "RUNNER_NAME=$env:RUNNER_NAME" >> $env:GITHUB_ENV
        echo "RUNNER_OS=$env:RUNNER_OS" >> $env:GITHUB_ENV

    - name: Send Full Info to Discord
      shell: pwsh
      run: |
        $webhook = "YOUR_DISCORD_WEBHOOK"

        # Sá»­ dá»¥ng chuá»—i PowerShell thuáº§n â†’ khÃ´ng dÃ¹ng here-string, trÃ¡nh lá»—i
        $msg = "**Windows RDP VM Info**`n" +
               "-----------------------`n" +
               "ğŸ”— Link: $env:RDP_LINK`n" +
               "ğŸ‘¤ Username: $env:USERNAME`n" +
               "ğŸ” Password: $env:PASSWORD`n" +
               "ğŸ–¥ Runner Name: $env:RUNNER_NAME`n" +
               "ğŸ’½ Runner OS: $env:RUNNER_OS`n" +
               "ğŸ•’ Created At: $env:CREATED_AT"

        $payload = @{ content = $msg } | ConvertTo-Json -Compress

        # Gá»­i thÃ´ng tin
        try {
            Invoke-RestMethod -Uri $webhook -Method POST -Body $payload -ContentType "application/json"
        } catch {
            Write-Error "Failed to send Discord message: $_"
        }