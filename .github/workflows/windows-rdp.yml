name: Windows RDP Full Info to Discord

on:
  workflow_dispatch:   # Cho phÃ©p nÃºt Run workflow xuáº¥t hiá»‡n

jobs:
  rdp:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Enable RDP & Firewall
      shell: pwsh
      run: |
        # Báº­t RDP
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" `
          -Name "fDenyTSConnections" -Value 0
        # Má»Ÿ firewall cho Remote Desktop
        netsh advfirewall firewall set rule group="remote desktop" new enable=yes

    - name: Download Cloudflared
      shell: pwsh
      run: |
        Invoke-WebRequest `
          -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" `
          -OutFile "$env:USERPROFILE\cloudflared.exe"

    - name: Start Cloudflare Tunnel & Save Info
      shell: pwsh
      run: |
        $cf = "$env:USERPROFILE\cloudflared.exe"

        # Táº¡o tunnel vÃ  láº¥y link RDP
        $rdp_link = & $cf tunnel --url rdp://localhost:3389 --print-url

        # LÆ°u thÃ´ng tin vÃ o environment
        echo "RDP_LINK=$rdp_link" >> $env:GITHUB_ENV
        echo "USERNAME=runneradmin" >> $env:GITHUB_ENV
        echo "PASSWORD=Password123!" >> $env:GITHUB_ENV
        echo "CREATED_AT=$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> $env:GITHUB_ENV
        echo "RUNNER_NAME=$env:RUNNER_NAME" >> $env:GITHUB_ENV
        echo "RUNNER_OS=$env:RUNNER_OS" >> $env:GITHUB_ENV

    - name: Send Full Info to Discord
      shell: pwsh
      run: |
        $webhook = "https://discord.com/api/webhooks/1438779054550417511/6Q-W-E5GTLVoE0zkK8ZBQ3nrt-ZDWFSOSPw5058Y7MY0iDse5_oAS7wmBRMJoNR0UhYk"

        # DÃ¹ng here-string Ä‘á»ƒ giá»¯ Ä‘á»‹nh dáº¡ng
        $msg = @"
**Windows RDP VM Info**
-----------------------
ğŸ”— Link: $env:RDP_LINK
ğŸ‘¤ Username: $env:USERNAME
ğŸ” Password: $env:PASSWORD
ğŸ–¥ Runner Name: $env:RUNNER_NAME
ğŸ’½ Runner OS: $env:RUNNER_OS
ğŸ•’ Created At: $env:CREATED_AT
"@

        $payload = @{ content = $msg } | ConvertTo-Json -Compress

        Invoke-RestMethod -Uri $webhook -Method POST -Body $payload -ContentType "application/json"