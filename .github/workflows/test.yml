name: CloudRDP

on:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: "Th·ªùi gian gi·ªØ m√°y ho·∫°t ƒë·ªông"
        required: false
        default: "350"

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: T·∫°o user RDP
        run: |
          net user clouduser CloudPass123! /add
          net localgroup "Administrators" clouduser /add
          net localgroup "Remote Desktop Users" clouduser /add

      - name: B·∫≠t RDP m·∫∑c ƒë·ªãnh (3389)
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          netsh advfirewall firewall add rule name="RDP3389" dir=in action=allow protocol=TCP localport=3389

      - name: T·∫£i Cloudflared
        run: |
          Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe

      - name: T·∫°o Tunnel Cloudflared TCP (kh√¥ng d√πng c·ªïng 3389)
        id: tunnel
        run: |
          $localPort = 3389
          $remotePort = 3390

          Write-Output "üîó ƒêang t·∫°o tunnel TCP‚Ä¶"
          $output = & .\cloudflared.exe tunnel --url tcp://localhost:$localPort --no-autoupdate --metrics localhost:0 --protocol http2 --remote-port $remotePort 2>&1

          Write-Output "RAW OUTPUT:"
          Write-Output $output

          $tcp = ($output | Select-String -Pattern "tcp://.*").Matches.Value
          if (-not $tcp) {
            Write-Output "‚ùå Kh√¥ng t√¨m th·∫•y URL TCP trong output."
            exit 1
          }
          echo "tcp=$tcp" >> $env:GITHUB_OUTPUT

      - name: In th√¥ng tin RDP
        run: |
          Write-Output "=========================== "
          Write-Output "          TH√îNG TIN RDP"
          Write-Output "=========================== "
          Write-Output "User     : clouduser"
          Write-Output "Pass     : CloudPass123!"
          Write-Output "RDP Link : ${{ steps.tunnel.outputs.tcp }}"
          Write-Output "=========================== "

      - name: Gi·ªØ m√°y Online
        run: |
          $end = (Get-Date).AddMinutes(${ { github.event.inputs.runtime_minutes } })
          while ((Get-Date) -lt $end) {
            Start-Sleep -Seconds 30
          }